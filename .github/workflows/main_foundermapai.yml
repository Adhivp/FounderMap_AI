name: Build and Deploy to Azure Container Apps

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Log in to Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Build the Docker image
        run: |
          docker build -t myapp:latest .

      - name: Export Docker image to a tarball
        run: |
          docker save myapp:latest -o myapp.tar

      - name: Deploy to Azure Container Apps
        run: |
          # Create an environment if it doesn't exist
          if ! az containerapp env show --name MyContainerAppEnv --resource-group Foundermap_ai; then
            echo "Creating Azure Container App environment..."
            az containerapp env create --name MyContainerAppEnv --resource-group Foundermap_ai --location southindia
          fi

          # Check if the container app exists
          if az containerapp show --resource-group Foundermap_ai --name foundermapaicontainerapp; then
            echo "Updating existing Container App"
            # Update the container app using the built image
            az containerapp update --name foundermapaicontainerapp \
                                   --resource-group Foundermap_ai \
                                   --image docker-archive://myapp.tar
          else
            echo "Creating a new Container App"
            # Create the container app using the built image
            az containerapp create --name foundermapaicontainerapp \
                                   --resource-group Foundermap_ai \
                                   --image docker-archive://myapp.tar \
                                   --target-port 8000 \
                                   --ingress external \
                                   --environment MyContainerAppEnv
          fi
